<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

</head>
<body ng-app="app" ng-controller="MainCtrl">

<keypress></keypress>

<div class="container">
    <div class="row">
        <div class="col-md-offset-2 col-md-8 col-xs-12">
            <button ng-click="change('dialogue14')">Dialogue 14</button>
            <button ng-click="change('dialogue22')">Dialogue 22</button>
            <button ng-click="change('dialogue23')">Dialogue 23</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-offset-2 col-md-8 col-xs-12">
            <div class="col-md-12 text-center">
                <player file-url="{{subscript.fileUrl}}" is-playing="isPlaying" time-callback="time" jump-to="jumpTo"></player>
                <label>
                    <span>Repeat count </span>
                    <select ng-model="repeatCount">
                        <option value="0">Don't repeat</option>
                        <option value="1">2</option>
                        <option value="2">3</option>
                        <option value="3">4</option>
                        <option value="4">5</option>
                    </select>
                </label>
            </div>
        </div>
    </div>
    <hr/>
    <div class="row">
        <div class="col-md-offset-2 col-md-8 col-xs-12">

            <ol>
                <li ng-repeat="sub in subscript.data" class=""><p><a href="javascript:;" ng-click="jump(sub)"><span ng-class="{'text-danger': lastSub.id == sub.id}">{{sub.text}}</span></a></p></li>
            </ol>
        </div>
    </div>
</div>

<script src="http://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.min.js"></script>

<script type="text/javascript">

    var app = angular.module('app', [])
        .directive('player', function() {
            return {
                restrict: 'E',
                scope: {
                    isPlaying: "=",
                    fileUrl: "@",
                    timeCallback: "=",
                    jumpTo: "="
                },
                replace: true,
                template: "<audio player controls> <p>Your browser does not support the <code>audio</code> element.</p> </audio>",
                link: function(scope, element, attrs) {
                    scope.$watch('fileUrl', function (fileUrl) {
                        element.removeAttr('src');
                        element.attr('src', fileUrl);
                    });

                    scope.$watch('isPlaying', function (isPlaying) {
                        if (isPlaying) {
                            element[0].play();
                        } else {
                            element[0].pause();
                        }
                    });

                    scope.$watch('jumpTo', function (time) {
                        if (time != -1) {
                            element[0].currentTime = time;
                            scope.jumpTo = -1;
                        }
                    });

                    element.on('timeupdate',function() {
                        scope.timeCallback = this.currentTime;
                        scope.$apply();
                    });
                }
            };
        })
        .directive('keypress', function() {
            return {
                restrict: 'E',
                replace: true,
                scope: true,
                link: function (scope, element, attrs) {
                    jQuery(document).on('keypress', function(e){
                        if (e.keyCode == 32) {
                            e.preventDefault();
                        }
                        scope.keyPressed(e);
                    });
                }
            };
        })
        .controller('MainCtrl', function($scope) {
            var dialogue14 = 
            {
                fileUrl: 'https://www.dropbox.com/s/iw9pbrysoe56hf0/Grammaire_en_dialogues_No18.mp3?raw=1',
                data: [
                    {id: 1,  text: "Simon : Est-ce que tu aimes lire ?", time: 11.0},
                    {id: 2,  text: "Clément : Ah oui ; j’adore lire ! En fait, je lis quelque chose chaque soir avant de me coucher.", time: 13},
                    {id: 3,  text: "Simon : Qu’est-ce que tu préfères lire ?", time: 17.5},
                    {id: 4,  text: "Clément : Ça dépend. Certaines jours, je préfère lire un roman , d’autres jours de la poésie...", time: 19},
                    {id: 5,  text: "Simon : Qu'est-ce tu lis, en ce moment? Tu lis quelque chose d'intéressant?", time: 24},
                    {id: 6,  text: "Clément : Oui, je lis quelque chose de très beau. Je lis quelques poèmes de Prévert.", time: 28},
                    {id: 7,  text: "Simon : C'est qui, Prévert?", time: 33.5},
                    {id: 8,  text: "Clément : Tu ne connais pas Prévert? Mais tu ne connais rien! Tout le monde connaît Prévert. C'est quelqu'un de merveilleux. C'est un grand poète du xx siècle", time: 34.6},
                    {id: 9,  text: "Simon : Je connais juste quelques écrivains modernes... Tu sais, moi, la littérature... Tu connais tous les poèmes de Prévert?", time: 42.8},
                    {id: 10,  text: "Clément : Oh, oui, je connais plusieurs poésies. Par exemple, j'aime beaucoup \"Pour faire le portrait d'un oiseau\". Je me rappelle seulement quelques phrases par coeur.", time: 50.5},
                    {id: 11,  text: "C'est le début, je crois: \"Peindre d'abord une cage avec une porte ouverte. Peindre ensuite quelque chose de joli, quelque chose de simple, quelque chose de beau, quelque chose d'utile pour l'oiseau..\".", time: 60},
                    {id: 12,  text: "Simon : Ah oui, c'est pas mal... C'est dans quel livre?", time: 74.5},
                    {id: 13,  text: "Clément : C'est quelque part dans ce livre, Paroles. Ah, voilà, page 154.", time: 78},
                    {id: 14,  text: "Tu vois, chaque poème a un style différent: certains poèmes sont très courts, d'autres très longs.", time: 84},
                    {id: 15,  text: "Certains sont romantiques, d'autre ironiques...", time: 89.5},
                    {id: 16,  text: "Simon : Et Prévert a écrit quelque chose d'amusant?", time: 92.8},
                    {id: 17,  text: "Clément : Oui, bien sûr, il y a plusieurs poèmes amusants: \"Cotège\", ou \"Les Belles Familles\"", time: 94.7},
                    {id: 18,  text: "Simon : Tu as vraiment tous les livres de Prévert dans ta bibliothèque?", time: 100.5},
                    {id: 19,  text: "Clément : Oui, je crois. J'ai aussi plusieurs livres de poésie américaine, anglaise, allemande...", time: 103.5},
                    {id: 20,  text: "Clément : Dis-moi, où est-ce que je peux acheter des livres de Prévert?", time: 109.5},
                    {id: 21,  text: "Simon : Dans toutes les bonnes librairies. ", time: 113}
                ]
            };
            var dialogue22 =
            {
                fileUrl: 'https://www.dropbox.com/s/3mnau582yifza2e/Grammaire_en_dialogues_No27.mp3?raw=1',
                data: [
                    {id: 1,  text: "Léon: Qu'est-ce que lu feras. l'été prochain?", time: 11.5},
                    {id: 2,  text: "Gilles: Je ne sais pas exactement. le partirai peut-être en Angleterre.", time: 13},
                    {id: 3,  text: "Léon: Ah bon? Et où est-ce que tu iras?", time: 15.8},
                    {id: 4,  text: "Gilles: À Londres. l'ai des amis là-bas. Ils habitent dans la banlieue de Londres.", time: 17.4},
                    {id: 5,  text: "Léon: Tu vivras chez eux ?", time: 21.3},
                    {id: 6,  text: "Cilles: Non, je n'habiterai pas chez eux, je chercherai probablement un appartement à partager avec un ou deux autres. C'est assez courant, là-bas.", time: 22.4},
                    {id: 7,  text: "Léon : Tu ne travailleras pas?", time: 28.6},
                    {id: 8,  text: "Gilles: Si, je crois que je trouverai faci lement un petit boulot·, pour l'été au moins.", time: 29.6},
                    {id: 9,  text: "Léon: Ce sera bien!", time: 34.5},
                    {id: 10, text: "Cilles: Oui, et puis comme ça, j'apprendrai l'anglais! Ce sera plus intéressant qu'à la faq.", time: 35.5},
                    {id: 11, text: "Léon : Tu veux dire que tu rencontreras une charmante Anglaise... ", time: 39.8},
                    {id: 12, text: "Oh non, je plaisante! Sérieusement, tu prendras des cours quelque part ?", time: 43},
                    {id: 13, text: "Gilles: Oui, je chercherai une école ou un bon professeur...", time: 47},
                    {id: 14, text: "Tu verras, je ferai des progrès spectaculaires, et je parlerai mieux que toi!", time: 50.8},
                    {id: 15, text: "Léon: Ce n'est pas difficile... El qu'est-ce que tu feras d'autre? Tu feras un peu de tourisme?", time: 55},
                    {id: 16, text: "Gilles: Oui, bien sûr... Je verrai sur place. En fait, cela dépendra des possibili tés... et de mes finances !", time: 61},
                    {id: 17, text: "Léon: Je t'imagine très bien à Londres: tu prendras le bus, ", time: 68.5},
                    {id: 18, text: "tu feras ton jogging à Hyde Park, et lu passeras tes soirées dans les pubs ...", time: 72.2},
                    {id: 19, text: "Gilles: Tu veux dire que je connaîtrai toutes les boîtes· de Londres?", time: 75.8},
                    {id: 20, text: "Léon: Bien sûr! Elles sont super·, non ? Bon, et après l'été, tu resteras là-bas ou tu reviendras ici ?", time: 78.2},
                    {id: 21, text: "Gilles: Franchement, je ne sais pas. Je resterai peut-être là-bas...", time: 83.7},
                    {id: 22, text: "Tu comprends, faire une expérience internationale, c'est toujours intéressant.", time: 89},
                    {id: 23, text: "Léon: Oui, et après, tu pourras revenir ici avec une double compétence,", time: 93},
                    {id: 24, text: "linguistique et professionnelle. C'est vra iment une très bonne idée!", time: 96.5},
                    {id: 25, text: "Gilles : Alors, tu viendras me voir à Londres?", time: 99.7},
                    {id: 26, text: "Léon : Évidemment!", time: 102.5}
                ]
            };

            var dialogue23 =
            {
                fileUrl: 'https://www.dropbox.com/s/0gu5zbjjqv5klr7/Grammaire_en_dialogues_No28.mp3?raw=1',
                data: [
                    {id: 1,  text: "Bernard : Tu penses que Jean-Marc viendra ?", time: 11.5},
                    {id: 2,  text: "Julien : Oui, j’espère qu’il viendra ! S’il ne vient pas, nous ne pourrons pas prendre de décision !", time: 13.2},
                    {id: 3,  text: "Bernard : Mais il sera en retard, comme d’habitude…", time: 17.5},
                    {id: 4,  text: "Julien : Eh bien, on l’attendra…", time: 19.2},
                    {id: 5,  text: "Bernard : tu crois qu’il sera pour notre projet ?", time: 20.5},
                    {id: 6,  text: "Julien : Non, je ne pense pas… Il sera probablement contre… Il dira que nous n’avons pas assez réfléchi… Tu verras !", time: 22.5},
                    {id: 7,  text: "Bernard : Philippe ? Il sera là ?", time: 28.5},
                    {id: 8,  text: "Julien : Oui, il sera là.", time: 30},
                    {id: 9,  text: "Bernard : Il sera contre notre projet, lui aussi ?", time: 31},
                    {id: 10, text: "Julien : je ne crois pas. Si nous sommes suffisamment clairs et fermes, il ne sera pas contre. En tout cas, il sera intéressé.", time: 33.2},
                    {id: 11, text: "Bernard : Alors, comment est-ce que nous présenterons les choses ?", time: 39},
                    {id: 12, text: "Julien : On pourra commencer par les résultats du trimestre.", time: 41},
                    {id: 13, text: "Julien : Tout le monde posera des questions. ", time: 44},
                    {id: 14, text: "Julien : Cela prendra au moins une heure. ", time: 45.6},
                    {id: 15, text: "Julien : Après, nous ferons une petite pause pour le café, et enfin nous présenterons notre projet. ", time: 47.5},
                    {id: 16, text: "Julien : Si Jean-Marc dit que notre travail est trop superficiel, je demanderai à Philippe son opinion. ", time: 52.2},
                    {id: 17, text: "Julien : Je connais Philippe, il restera très calme, il nous posera des questions simples et intelligentes.", time: 57},
                    {id: 18, text: "Bernard : Pour les questions techniques, situ veux, je pourrai répondre.", time: 62},
                    {id: 19, text: "Julien : bonne idée ! Quand tu parleras, cela impressionnera Jean-Marc, parce que tu connais parfaitement ton sujet.", time: 65},
                    {id: 20, text: "Bernard : Oui, mais si Jean-Marc refuse vraiment ?", time: 70},
                    {id: 21, text: "Julien : À ce moment-là, je demanderai à Grégoire de venir. S’il est là, tout le monde l’écoutera, et Jean-Marc fera comme tout le monde !", time: 72},
                    {id: 22, text: "Bernard : Je vois… Et quand tout le monde sera d’accord, nous sortirons le champagne ! Enfin… J’espère que tout ira bien ! Je suis un peu inquiet, quand même !", time: 79.3},
                    {id: 23, text: "Julien : Mais non ! Tu verras, tout se passera bien !", time: 86.5}
                ]
            };


            var subscripts = {
                dialogue14: dialogue14,
                dialogue22: dialogue22,
                dialogue23: dialogue23
            };

            $scope.jump = function(sub) {
                $scope.lastSub = sub;
                $scope.isPlaying = true;
                $scope.jumpTo = sub.time;
            };
            $scope.change = function(dialogue) {
                $scope.subscript = subscripts[dialogue];
                $scope.fileUrl = $scope.subscript.fileUrl;
            };

            $scope.keyPressed = function(e) {
                if (e.keyCode == 32) {
                    $scope.isPlaying = !$scope.isPlaying;
                } else if (e.keyCode == 47) {
                    $scope.jump($scope.lastSub);
                } else if (e.keyCode == 44) {
                    $scope.jump($scope.prevSub());
                } else if (e.keyCode == 46) {
                    $scope.jump($scope.nextSub());
                }
                $scope.$apply();
            };

            $scope.prevSub = function() {
                return $scope.subscript.data[$scope.lastSub.id - 2];
            };
            $scope.nextSub = function() {
                return $scope.subscript.data[$scope.lastSub.id];
            };

            $scope.timeUpdated = function(time) {
                if ($scope.lastSub && time >= ($scope.nextSub().time - 0.2)) { // if true, then passing to the next sub
                    if ($scope.repeatsLeft > 0) {
                        $scope.jump($scope.lastSub);
                        $scope.repeatsLeft = $scope.repeatsLeft - 1;
                    } else {
                        $scope.lastSub = $scope.nextSub();
                        $scope.repeatsLeft = parseInt($scope.repeatCount);
                    }
                }
            };
            $scope.$watch("time", function (time) {
                $scope.timeUpdated(time);
            });
            $scope.$watch("repeatCount", function (repeatCount) {
                $scope.repeatsLeft = parseInt(repeatCount);
            });

            $scope.repeatCount = "0";
            $scope.repeatsLeft = parseInt($scope.repeatCount);
            $scope.time = 0;
            $scope.jumpTo = 0;
            $scope.isPlaying = false;
            $scope.change("dialogue14");

        });
</script>

</body>
</html>
